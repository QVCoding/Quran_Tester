<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Occurrence Tester</title>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: white;
            --bg-tertiary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #333;
            --text-tertiary: #555;
            --text-quaternary: #666;
            --border-color: #ddd;
            --button-primary: #3498db;
            --button-primary-hover: #2980b9;
            --button-disabled: #bdc3c7;
            --error-bg: #fadbd8;
            --error-text: #e74c3c;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #d0d0d0;
            --text-tertiary: #b0b0b0;
            --text-quaternary: #999;
            --border-color: #4a4a4a;
            --button-primary: #3498db;
            --button-primary-hover: #2980b9;
            --button-disabled: #5a5a5a;
            --error-bg: #4a2a2a;
            --error-text: #ff6b6b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 24px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: var(--border-color);
            border-radius: 12px;
            transition: background-color 0.3s;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        #dark-mode-toggle:checked + .toggle-switch {
            background-color: #3498db;
        }

        #dark-mode-toggle:checked + .toggle-switch .toggle-slider {
            transform: translateX(26px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-quaternary);
        }

        .controls {
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .filter-options-box {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .occurrence-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .surah-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            background: var(--bg-secondary);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .surah-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .surah-item input {
            margin-right: 8px;
        }

        .surah-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .juz-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 5px;
        }

        .juz-item {
            display: flex;
            align-items: center;
        }

        .juz-item input {
            margin-right: 5px;
        }

        .juz-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-group {
            margin-top: 10px;
        }

        .checkbox-group input {
            margin-right: 8px;
        }

        .checkbox-group label {
            display: inline;
            font-weight: normal;
        }

        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            background: #3498db;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            vertical-align: middle;
        }

        .info-tooltip {
            display: none;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            margin-top: 5px;
            font-size: 13px;
            color: var(--text-tertiary);
            line-height: 1.5;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        .info-tooltip.show {
            display: block;
        }

        .question-types {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }

        button {
            background-color: var(--button-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--button-primary-hover);
        }

        button[style*="background-color: #27ae60"]:hover {
            background-color: #229954 !important;
        }

        button:disabled {
            background-color: var(--button-disabled);
            cursor: not-allowed;
        }

        .test-area {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            min-height: 200px;
            transition: background-color 0.3s;
        }

        .question-display {
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-bottom: 20px;
            color: var(--text-primary);
            transition: background-color 0.3s;
        }

        .phrase-display {
            font-size: 28px;
            text-align: center;
            padding: 30px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-bottom: 20px;
            direction: rtl;
            line-height: 1.8;
            transition: background-color 0.3s;
        }

        .answer-display {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .answer-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .occurrence-item {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            border-left: 4px solid #3498db;
            transition: background-color 0.3s;
        }

        .occurrence-number {
            font-weight: 600;
            color: #3498db;
            margin-bottom: 8px;
        }

        .occurrence-verse {
            font-size: 22px;
            direction: rtl;
            line-height: 2;
            margin-bottom: 10px;
        }

        .occurrence-verse .phrase-highlight {
            font-weight: bold;
            color: #e74c3c;
        }

        .occurrence-metadata {
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .occurrence-metadata div {
            margin-bottom: 3px;
        }

        .no-occurrences {
            text-align: center;
            padding: 20px;
            color: var(--text-tertiary);
            font-style: italic;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .error {
            color: var(--error-text);
            padding: 10px;
            background: var(--error-bg);
            border-radius: 4px;
            margin-bottom: 10px;
            transition: background-color 0.3s, color 0.3s;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 20px;
            }

            .container > div:first-child {
                position: static;
            }

            .container > div:first-child > div:last-child {
                position: static !important;
                display: flex;
                justify-content: center;
                margin-top: 10px;
                margin-bottom: 10px;
            }

            .phrase-display {
                font-size: 22px;
                padding: 20px;
            }

            .occurrence-verse {
                font-size: 20px;
            }

            button {
                padding: 10px 16px;
                font-size: 14px;
            }

            .juz-container {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="position: relative;">
            <h1 style="text-align: center;">Quran Occurrence Tester</h1>
            <p style="text-align: center; color: var(--text-quaternary); margin-bottom: 20px; font-size: 14px;">Test your memorization by identifying specific occurrences of repeated phrases. You will be shown a phrase from the Quran and asked questions about where it comes in the Quran.</p>
            
            <div style="position: absolute; top: 0; right: 0;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px;">
                    <span style="margin-right: 8px;">ðŸŒ™</span>
                    <input type="checkbox" id="dark-mode-toggle" style="display: none;">
                    <div class="toggle-switch">
                        <div class="toggle-slider"></div>
                    </div>
                </label>
            </div>
        </div>
        
        <div id="loading" class="loading">Loading Quran data...</div>
        
        <div id="app" style="display: none;">
            <div class="controls">
                <div class="control-group">
                    <label>Number of Occurrences:
                        <span class="info-icon" onclick="toggleOccurrenceTooltip(event)" style="margin-left: 5px;">i</span>
                    </label>
                    <div id="occurrence-tooltip" class="info-tooltip">
                        The minimum and maximum number of times the phrase can come in the Quran. If this number is very low, it may be very easy to guess. If it is too high, the phrase you are shown can be very common in the Quran, making it hard to guess. The default values are 2-5 occurrences.
                    </div>
                    <div class="occurrence-inputs">
                        <div>
                            <label style="font-size: 13px; font-weight: normal;">Minimum:</label>
                            <input type="number" id="min-occurrences" value="2" min="1" max="100">
                        </div>
                        <div>
                            <label style="font-size: 13px; font-weight: normal;">Maximum:</label>
                            <input type="number" id="max-occurrences" value="5" min="1" max="100">
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label><strong>Select Portion for Testing:</strong></label>
                    <div style="margin-top: 10px;">
                        <input type="radio" id="entire-quran" name="portion-type" value="entire" checked>
                        <label for="entire-quran" style="display: inline; font-weight: normal;">Entire Quran (default)</label>
                    </div>
                    <div style="margin-top: 5px;">
                        <input type="radio" id="select-portion" name="portion-type" value="select">
                        <label for="select-portion" style="display: inline; font-weight: normal;">Select Portion</label>
                    </div>
                    <div id="portion-description" style="display: none; margin-top: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 4px; font-size: 13px; color: var(--text-tertiary);">
                        All questions will be shown from the selected portion only. For "Find the Nth occurrence" and "How many times" questions, consider <em>only</em> this portion (the Nth time the phrase occurs <em>in this portion</em>, how many times does it appear <em>in this portion</em>).
                    </div>
                </div>

                <div id="filter-options" class="filter-options-box" style="display: none;">
                    <div class="control-group">
                        <label>Surah Select:</label>
                        <div id="surah-container" class="surah-container">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Juz Select:</label>
                        <div id="juz-container" class="juz-container">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="page-range">Page Select (comma separated ranges, e.g. "1-100" or "1-100, 150-200"):</label>
                        <input type="text" id="page-range" placeholder="e.g., 1-100, 150-200, 300">
                        <div id="page-range-error" style="color: var(--error-text); font-size: 13px; margin-top: 5px; display: none;">Invalid Range</div>
                    </div>
                </div>

                <div class="control-group">
                    <label><strong>Question Types (select at least one):</strong></label>
                    <div class="question-types">
                        <div class="checkbox-group">
                            <input type="checkbox" id="q-type-nth" checked>
                            <label for="q-type-nth">Find the Nth occurrence</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="q-type-count" checked>
                            <label for="q-type-count">How many times does this phrase appear?</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="q-type-surah" checked>
                            <label for="q-type-surah">Does this phrase appear in Surah X?</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="q-type-juz" checked>
                            <label for="q-type-juz">Does this phrase appear in Juz X?</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button id="new-question-btn" onclick="startNewQuestion()">New Question</button>
                <button id="change-settings-btn" onclick="showSettings()" style="display: none; background-color: #27ae60;">Change Settings</button>
            </div>

            <div id="error-message" class="error" style="display: none;"></div>

            <div id="test-area" class="test-area" style="display: none;">
                <div id="question-display" class="question-display"></div>
                <div id="phrase-display" class="phrase-display"></div>
                
                <div class="button-group">
                    <button id="reveal-btn" onclick="revealAnswer()">Reveal Answer</button>
                    <button id="next-question-btn" onclick="startNewQuestion()" style="display: none;">New Question</button>
                </div>

                <div id="answer-display" class="answer-display" style="display: none;"></div>

                <div class="button-group" style="margin-top: 20px;">
                    <button id="bottom-question-btn" onclick="startNewQuestion()" style="display: none;">New Question</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let quranWords = [];
        let metadata = null;
        let currentQuestion = null;

        // Load CSV file
        async function loadCSV() {
            const response = await fetch('quran_words.csv');
            const text = await response.text();
            const lines = text.trim().split('\n');
            
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',');
                if (parts.length >= 5) {
                    quranWords.push({
                        globalWordNumber: parseInt(parts[0]),
                        sura: parseInt(parts[1]),
                        aya: parseInt(parts[2]),
                        wordInAya: parseInt(parts[3]),
                        text: parts.slice(4).join(',')
                    });
                }
            }
        }

        // Load XML file
        async function loadXML() {
            const response = await fetch('app_quran_metadata.xml');
            const text = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, 'text/xml');
            
            metadata = {
                suras: [],
                juzs: [],
                pages: []
            };

            const suras = xmlDoc.querySelectorAll('sura');
            suras.forEach(sura => {
                metadata.suras.push({
                    index: parseInt(sura.getAttribute('index')),
                    name: sura.getAttribute('name')
                });
            });

            const juzs = xmlDoc.querySelectorAll('juz');
            juzs.forEach(juz => {
                metadata.juzs.push({
                    index: parseInt(juz.getAttribute('index')),
                    sura: parseInt(juz.getAttribute('sura')),
                    aya: parseInt(juz.getAttribute('aya'))
                });
            });

            const pages = xmlDoc.querySelectorAll('page');
            pages.forEach(page => {
                metadata.pages.push({
                    index: parseInt(page.getAttribute('index')),
                    sura: parseInt(page.getAttribute('sura')),
                    aya: parseInt(page.getAttribute('aya'))
                });
            });
        }

        // Initialize the app
        async function init() {
            try {
                await loadCSV();
                await loadXML();
                
                // Populate surah checkboxes
                const surahContainer = document.getElementById('surah-container');
                metadata.suras.forEach(sura => {
                    const div = document.createElement('div');
                    div.className = 'surah-item';
                    div.innerHTML = `
                        <input type="checkbox" id="surah-${sura.index}" value="${sura.index}">
                        <label for="surah-${sura.index}">${sura.index}. ${sura.name}</label>
                    `;
                    surahContainer.appendChild(div);
                });

                // Populate juz checkboxes
                const juzContainer = document.getElementById('juz-container');
                for (let i = 1; i <= 30; i++) {
                    const div = document.createElement('div');
                    div.className = 'juz-item';
                    div.innerHTML = `
                        <input type="checkbox" id="juz-${i}" value="${i}">
                        <label for="juz-${i}">Juz ${i}</label>
                    `;
                    juzContainer.appendChild(div);
                }

                // Event listener for portion type radio buttons
                document.querySelectorAll('input[name="portion-type"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const filterOptions = document.getElementById('filter-options');
                        const portionDescription = document.getElementById('portion-description');
                        if (e.target.value === 'select') {
                            filterOptions.style.display = 'block';
                            portionDescription.style.display = 'block';
                        } else {
                            filterOptions.style.display = 'none';
                            portionDescription.style.display = 'none';
                            clearSurahSelection();
                            clearJuzSelection();
                            clearPageRange();
                        }
                    });
                });

                // Event listeners for filter clearing
                document.querySelectorAll('[id^="surah-"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            clearJuzSelection();
                            clearPageRange();
                        }
                    });
                });

                document.querySelectorAll('[id^="juz-"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            clearSurahSelection();
                            clearPageRange();
                        }
                    });
                });

                document.getElementById('page-range').addEventListener('input', (e) => {
                    const pageRangeError = document.getElementById('page-range-error');
                    if (e.target.value.trim()) {
                        clearSurahSelection();
                        clearJuzSelection();
                        
                        const pages = parsePageRange(e.target.value.trim());
                        if (pages === null) {
                            pageRangeError.style.display = 'block';
                        } else {
                            pageRangeError.style.display = 'none';
                        }
                    } else {
                        pageRangeError.style.display = 'none';
                    }
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';

                // Dark mode toggle
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    darkModeToggle.checked = true;
                }

                darkModeToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.documentElement.setAttribute('data-theme', 'light');
                        localStorage.setItem('theme', 'light');
                    }
                });

                // Close tooltips when clicking outside
                document.addEventListener('click', function(event) {
                    const infoIcon = event.target.closest('.info-icon');
                    if (!infoIcon) {
                        const occurrenceTooltip = document.getElementById('occurrence-tooltip');
                        if (occurrenceTooltip) occurrenceTooltip.classList.remove('show');
                    }
                });
            } catch (error) {
                document.getElementById('loading').textContent = 'Error loading data. Please ensure quran_words.csv and app_quran_metadata.xml are in the same folder as this HTML file.';
                console.error(error);
            }
        }

        function clearSurahSelection() {
            document.querySelectorAll('[id^="surah-"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function clearJuzSelection() {
            document.querySelectorAll('[id^="juz-"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function clearPageRange() {
            document.getElementById('page-range').value = '';
            document.getElementById('page-range-error').style.display = 'none';
        }

        // Get filtered words based on user selection
        function getFilteredWords() {
            const selectedSuras = Array.from(document.querySelectorAll('[id^="surah-"]:checked')).map(cb => parseInt(cb.value));
            const selectedJuzs = Array.from(document.querySelectorAll('[id^="juz-"]:checked')).map(cb => parseInt(cb.value));
            const pageRangeText = document.getElementById('page-range').value.trim();

            if (selectedSuras.length > 0) {
                return quranWords.filter(word => selectedSuras.includes(word.sura));
            } else if (selectedJuzs.length > 0) {
                return quranWords.filter(word => {
                    const juz = findJuzForWord(word);
                    return selectedJuzs.includes(juz);
                });
            } else if (pageRangeText) {
                const pages = parsePageRange(pageRangeText);
                if (pages === null || pages.length === 0) return [];
                return quranWords.filter(word => {
                    const page = findPageForWord(word);
                    return pages.includes(page);
                });
            }

            return quranWords;
        }

        // Parse page range string
        function parsePageRange(rangeText) {
            const pages = new Set();
            const parts = rangeText.split(',');
            
            if (parts.length === 0 || rangeText.trim() === '') {
                return null;
            }
            
            for (let part of parts) {
                part = part.trim();
                if (part === '') continue;
                
                if (part.includes('-')) {
                    const rangeParts = part.split('-');
                    if (rangeParts.length !== 2) {
                        return null;
                    }
                    const start = parseInt(rangeParts[0].trim());
                    const end = parseInt(rangeParts[1].trim());
                    if (isNaN(start) || isNaN(end) || start < 1 || end > 604 || start > end) {
                        return null;
                    }
                    for (let i = start; i <= end; i++) {
                        pages.add(i);
                    }
                } else {
                    const page = parseInt(part);
                    if (isNaN(page) || page < 1 || page > 604) {
                        return null;
                    }
                    pages.add(page);
                }
            }
            
            if (pages.size === 0) {
                return null;
            }
            
            return Array.from(pages);
        }

        // Find juz for a word
        function findJuzForWord(word) {
            for (let i = metadata.juzs.length - 1; i >= 0; i--) {
                const juz = metadata.juzs[i];
                if (word.sura > juz.sura || (word.sura === juz.sura && word.aya >= juz.aya)) {
                    return juz.index;
                }
            }
            return 1;
        }

        // Find page for a word
        function findPageForWord(word) {
            for (let i = metadata.pages.length - 1; i >= 0; i--) {
                const page = metadata.pages[i];
                if (word.sura > page.sura || (word.sura === page.sura && word.aya >= page.aya)) {
                    return page.index;
                }
            }
            return 1;
        }

        // Normalize text for comparison (remove shaddah at position 2)
        function normalizeForComparison(text) {
            if (text.length >= 2 && text.charCodeAt(1) === 0x0651) {
                return text.charAt(0) + text.substring(2);
            }
            return text;
        }

        // Find all occurrences of a phrase in filtered words
        function findPhraseOccurrences(phrase, filteredWords) {
            const occurrences = [];
            const normalizedPhrase = phrase.map((word, idx) => 
                idx === 0 ? normalizeForComparison(word.text) : word.text
            );

            for (let i = 0; i <= filteredWords.length - phrase.length; i++) {
                let matches = true;
                
                // Check if phrase matches
                for (let j = 0; j < phrase.length; j++) {
                    const currentWord = filteredWords[i + j].text;
                    const normalizedCurrent = j === 0 ? normalizeForComparison(currentWord) : currentWord;
                    if (normalizedCurrent !== normalizedPhrase[j]) {
                        matches = false;
                        break;
                    }
                }

                // Check if all words are in the same ayah
                if (matches) {
                    const startWord = filteredWords[i];
                    const endWord = filteredWords[i + phrase.length - 1];
                    if (startWord.sura === endWord.sura && startWord.aya === endWord.aya) {
                        occurrences.push({
                            startIndex: i,
                            words: filteredWords.slice(i, i + phrase.length)
                        });
                    }
                }
            }

            return occurrences;
        }

        // Find a random phrase with the right number of occurrences
        function findRandomPhrase(filteredWords, minOccurrences, maxOccurrences) {
            const maxAttempts = 200;
            
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                // Pick random starting point
                const startIndex = Math.floor(Math.random() * filteredWords.length);
                const startWord = filteredWords[startIndex];
                
                // Try different phrase lengths (1 to 10 words)
                const maxLength = Math.min(10, filteredWords.length - startIndex);
                for (let length = 1; length <= maxLength; length++) {
                    // Check if phrase stays within one ayah
                    const endWord = filteredWords[startIndex + length - 1];
                    if (startWord.sura !== endWord.sura || startWord.aya !== endWord.aya) {
                        break; // Crossed ayah boundary
                    }

                    const phrase = filteredWords.slice(startIndex, startIndex + length);
                    const occurrences = findPhraseOccurrences(phrase, filteredWords);
                    
                    if (occurrences.length >= minOccurrences && occurrences.length <= maxOccurrences) {
                        return {
                            phrase: phrase,
                            occurrences: occurrences
                        };
                    }
                }
            }
            
            return null;
        }

        // Get enabled question types
        function getEnabledQuestionTypes() {
            const types = [];
            if (document.getElementById('q-type-nth').checked) types.push('nth');
            if (document.getElementById('q-type-count').checked) types.push('count');
            if (document.getElementById('q-type-surah').checked) types.push('surah');
            if (document.getElementById('q-type-juz').checked) types.push('juz');
            return types;
        }

        // Get unique surahs/juzs in the filtered portion
        function getUniqueSurahsInPortion(filteredWords) {
            const surahs = new Set();
            filteredWords.forEach(word => surahs.add(word.sura));
            return Array.from(surahs);
        }

        function getUniqueJuzsInPortion(filteredWords) {
            const juzs = new Set();
            filteredWords.forEach(word => juzs.add(findJuzForWord(word)));
            return Array.from(juzs);
        }

        // Generate a question
        function generateQuestion(phraseData, filteredWords, enabledTypes) {
            const occurrences = phraseData.occurrences;
            const availableTypes = [...enabledTypes];
            
            // Filter out question types that don't make sense
            const uniqueSurahs = getUniqueSurahsInPortion(filteredWords);
            const uniqueJuzs = getUniqueJuzsInPortion(filteredWords);
            
            if (uniqueSurahs.length <= 1) {
                availableTypes.splice(availableTypes.indexOf('surah'), 1);
            }
            if (uniqueJuzs.length <= 1) {
                availableTypes.splice(availableTypes.indexOf('juz'), 1);
            }
            
            if (availableTypes.length === 0) {
                return null;
            }
            
            const questionType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            
            switch (questionType) {
                case 'nth':
                    const n = Math.floor(Math.random() * occurrences.length) + 1;
                    const ordinal = n === 1 ? '1st' : n === 2 ? '2nd' : n === 3 ? '3rd' : `${n}th`;
                    return {
                        type: 'nth',
                        question: `Find the ${ordinal} occurrence of this phrase`,
                        answer: n,
                        showAll: true
                    };
                
                case 'count':
                    return {
                        type: 'count',
                        question: 'How many times does this phrase appear in total?',
                        answer: occurrences.length,
                        showAll: true
                    };
                
                case 'surah':
                    // Pick a random surah from the portion
                    const randomSurah = uniqueSurahs[Math.floor(Math.random() * uniqueSurahs.length)];
                    const surahName = metadata.suras.find(s => s.index === randomSurah).name;
                    const inSurah = occurrences.some(occ => occ.words[0].sura === randomSurah);
                    return {
                        type: 'surah',
                        question: `Does this phrase appear in Surah ${surahName}?`,
                        answer: inSurah,
                        filterSurah: randomSurah
                    };
                
                case 'juz':
                    const randomJuz = uniqueJuzs[Math.floor(Math.random() * uniqueJuzs.length)];
                    const inJuz = occurrences.some(occ => findJuzForWord(occ.words[0]) === randomJuz);
                    return {
                        type: 'juz',
                        question: `Does this phrase appear in Juz ${randomJuz}?`,
                        answer: inJuz,
                        filterJuz: randomJuz
                    };
            }
        }

        // Start a new question
        function startNewQuestion() {
            const errorDiv = document.getElementById('error-message');
            const pageRangeError = document.getElementById('page-range-error');
            errorDiv.style.display = 'none';
            pageRangeError.style.display = 'none';

            // Validate page range if provided
            const pageRangeText = document.getElementById('page-range').value.trim();
            if (pageRangeText) {
                const pages = parsePageRange(pageRangeText);
                if (pages === null) {
                    pageRangeError.style.display = 'block';
                    return;
                }
            }

            // Get settings
            const minOccurrences = parseInt(document.getElementById('min-occurrences').value);
            const maxOccurrences = parseInt(document.getElementById('max-occurrences').value);
            
            if (minOccurrences < 1 || maxOccurrences < minOccurrences) {
                errorDiv.textContent = 'Invalid occurrence range. Minimum must be at least 1 and maximum must be >= minimum.';
                errorDiv.style.display = 'block';
                return;
            }

            const enabledTypes = getEnabledQuestionTypes();
            if (enabledTypes.length === 0) {
                errorDiv.textContent = 'Please select at least one question type.';
                errorDiv.style.display = 'block';
                return;
            }

            const filteredWords = getFilteredWords();
            if (filteredWords.length === 0) {
                errorDiv.textContent = 'No words available with current filter settings.';
                errorDiv.style.display = 'block';
                return;
            }

            // Find a phrase
            const phraseData = findRandomPhrase(filteredWords, minOccurrences, maxOccurrences);
            if (!phraseData) {
                errorDiv.textContent = `Could not find a phrase with ${minOccurrences}-${maxOccurrences} occurrences. Try adjusting the occurrence range or portion.`;
                errorDiv.style.display = 'block';
                return;
            }

            // Generate question
            const question = generateQuestion(phraseData, filteredWords, enabledTypes);
            if (!question) {
                errorDiv.textContent = 'Could not generate a suitable question. Try different settings.';
                errorDiv.style.display = 'block';
                return;
            }

            currentQuestion = {
                phraseData: phraseData,
                question: question,
                filteredWords: filteredWords
            };

            // Display question
            document.getElementById('question-display').textContent = question.question;
            document.getElementById('phrase-display').textContent = phraseData.phrase.map(w => w.text).join(' ');

            // Hide controls, show test area
            document.querySelector('.controls').style.display = 'none';
            document.getElementById('change-settings-btn').style.display = 'inline-block';
            document.getElementById('new-question-btn').style.display = 'inline-block';

            document.getElementById('test-area').style.display = 'block';
            document.getElementById('answer-display').style.display = 'none';
            document.getElementById('reveal-btn').style.display = 'inline-block';
            document.getElementById('next-question-btn').style.display = 'none';
            document.getElementById('bottom-question-btn').style.display = 'none';
        }

        // Reveal the answer
        function revealAnswer() {
            if (!currentQuestion) return;

            const answerDiv = document.getElementById('answer-display');
            answerDiv.innerHTML = '';

            const { phraseData, question } = currentQuestion;
            let occurrencesToShow = phraseData.occurrences;

            // Filter occurrences based on question type
            if (question.type === 'surah') {
                occurrencesToShow = occurrencesToShow.filter(occ => occ.words[0].sura === question.filterSurah);
            } else if (question.type === 'juz') {
                occurrencesToShow = occurrencesToShow.filter(occ => findJuzForWord(occ.words[0]) === question.filterJuz);
            }

            // For "nth occurrence" questions, show the specific answer first
            if (question.type === 'nth') {
                const nthOccurrence = phraseData.occurrences[question.answer - 1];
                const ordinal = question.answer === 1 ? '1st' : question.answer === 2 ? '2nd' : question.answer === 3 ? '3rd' : `${question.answer}th`;
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'answer-header';
                headerDiv.textContent = `Answer: ${ordinal} occurrence`;
                answerDiv.appendChild(headerDiv);

                // Show the specific occurrence
                const occDiv = createOccurrenceElement(nthOccurrence, question.answer - 1, currentQuestion.filteredWords);
                answerDiv.appendChild(occDiv);

                // Add separator and show all occurrences
                const allHeaderDiv = document.createElement('div');
                allHeaderDiv.className = 'answer-header';
                allHeaderDiv.style.marginTop = '30px';
                allHeaderDiv.textContent = `All occurrences (${phraseData.occurrences.length} total):`;
                answerDiv.appendChild(allHeaderDiv);

                // Show all occurrences
                phraseData.occurrences.forEach((occurrence, index) => {
                    const occDiv = createOccurrenceElement(occurrence, index, currentQuestion.filteredWords);
                    answerDiv.appendChild(occDiv);
                });
            } else {
                // Show answer header for other question types
                const headerDiv = document.createElement('div');
                headerDiv.className = 'answer-header';
                
                if (question.type === 'count') {
                    headerDiv.textContent = `Answer: ${question.answer} occurrence${question.answer !== 1 ? 's' : ''}`;
                } else if (question.type === 'surah') {
                    const surahName = metadata.suras.find(s => s.index === question.filterSurah).name;
                    headerDiv.textContent = `Answer: ${question.answer ? 'Yes' : 'No'}${question.answer ? ` (${occurrencesToShow.length} occurrence${occurrencesToShow.length !== 1 ? 's' : ''} in Surah ${surahName})` : ''}`;
                } else if (question.type === 'juz') {
                    headerDiv.textContent = `Answer: ${question.answer ? 'Yes' : 'No'}${question.answer ? ` (${occurrencesToShow.length} occurrence${occurrencesToShow.length !== 1 ? 's' : ''} in Juz ${question.filterJuz})` : ''}`;
                }
                answerDiv.appendChild(headerDiv);

                if (occurrencesToShow.length === 0) {
                    const noOccDiv = document.createElement('div');
                    noOccDiv.className = 'no-occurrences';
                    noOccDiv.textContent = 'No occurrences in the specified location.';
                    answerDiv.appendChild(noOccDiv);
                } else {
                    // Show each occurrence
                    occurrencesToShow.forEach((occurrence, index) => {
                        const occDiv = createOccurrenceElement(occurrence, index, currentQuestion.filteredWords);
                        answerDiv.appendChild(occDiv);
                    });
                }
            }

            answerDiv.style.display = 'block';
            document.getElementById('reveal-btn').style.display = 'none';
            document.getElementById('next-question-btn').style.display = 'inline-block';
            document.getElementById('new-question-btn').style.display = 'none';
            document.getElementById('bottom-question-btn').style.display = 'inline-block';
        }

        // Helper function to create an occurrence element
        function createOccurrenceElement(occurrence, index, filteredWords) {
            const occDiv = document.createElement('div');
            occDiv.className = 'occurrence-item';

            // Occurrence number
            const numDiv = document.createElement('div');
            numDiv.className = 'occurrence-number';
            numDiv.textContent = `${index + 1}${index === 0 ? 'st' : index === 1 ? 'nd' : index === 2 ? 'rd' : 'th'} occurrence:`;
            occDiv.appendChild(numDiv);

            // Get full verse
            const firstWord = occurrence.words[0];
            const verseWords = filteredWords.filter(w => 
                w.sura === firstWord.sura && w.aya === firstWord.aya
            );
            
            // Build verse with phrase highlighted
            const verseDiv = document.createElement('div');
            verseDiv.className = 'occurrence-verse';
            
            const phraseText = occurrence.words.map(w => w.text).join(' ');
            const verseText = verseWords.map(w => w.text).join(' ');
            
            // Simple highlighting by replacing phrase text
            const highlightedVerse = verseText.replace(phraseText, `<span class="phrase-highlight">${phraseText}</span>`);
            verseDiv.innerHTML = highlightedVerse;
            occDiv.appendChild(verseDiv);

            // Metadata
            const surahName = metadata.suras.find(s => s.index === firstWord.sura).name;
            const juz = findJuzForWord(firstWord);
            const page = findPageForWord(firstWord);

            const metaDiv = document.createElement('div');
            metaDiv.className = 'occurrence-metadata';
            metaDiv.innerHTML = `
                <div><strong>Surah:</strong> ${surahName} (${firstWord.sura})</div>
                <div><strong>Ayah:</strong> ${firstWord.aya}</div>
                <div><strong>Juz:</strong> ${juz}</div>
                <div><strong>Page:</strong> ${page}</div>
            `;
            occDiv.appendChild(metaDiv);

            return occDiv;
        }

        // Show settings
        function showSettings() {
            document.querySelector('.controls').style.display = 'block';
            document.getElementById('test-area').style.display = 'none';
            document.getElementById('change-settings-btn').style.display = 'none';
            document.getElementById('new-question-btn').style.display = 'inline-block';
            document.getElementById('page-range-error').style.display = 'none';
            currentQuestion = null;
        }

        // Toggle occurrence tooltip visibility
        function toggleOccurrenceTooltip(event) {
            event.stopPropagation();
            const tooltip = document.getElementById('occurrence-tooltip');
            tooltip.classList.toggle('show');
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>