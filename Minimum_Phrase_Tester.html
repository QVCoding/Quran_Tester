<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Testing App</title>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: white;
            --bg-tertiary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #333;
            --text-tertiary: #555;
            --text-quaternary: #666;
            --border-color: #ddd;
            --button-primary: #3498db;
            --button-primary-hover: #2980b9;
            --button-disabled: #bdc3c7;
            --error-bg: #fadbd8;
            --error-text: #e74c3c;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #d0d0d0;
            --text-tertiary: #b0b0b0;
            --text-quaternary: #999;
            --border-color: #4a4a4a;
            --button-primary: #3498db;
            --button-primary-hover: #2980b9;
            --button-disabled: #5a5a5a;
            --error-bg: #4a2a2a;
            --error-text: #ff6b6b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 24px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: var(--border-color);
            border-radius: 12px;
            transition: background-color 0.3s;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        #dark-mode-toggle:checked + .toggle-switch {
            background-color: #3498db;
        }

        #dark-mode-toggle:checked + .toggle-switch .toggle-slider {
            transform: translateX(26px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-quaternary);
        }

        .controls {
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .filter-options-box {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        select, input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .surah-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            background: var(--bg-secondary);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .surah-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .surah-item input {
            margin-right: 8px;
        }

        .surah-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .juz-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 5px;
        }

        .juz-item {
            display: flex;
            align-items: center;
        }

        .juz-item input {
            margin-right: 5px;
        }

        .juz-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-group {
            margin-top: 10px;
        }

        .checkbox-group input {
            margin-right: 8px;
        }

        .checkbox-group label {
            display: inline;
            font-weight: normal;
        }

        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            background: #3498db;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
        }

        .info-tooltip {
            display: none;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            margin-top: 5px;
            font-size: 13px;
            color: var(--text-tertiary);
            line-height: 1.5;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        .info-tooltip.show {
            display: block;
        }

        button {
            background-color: var(--button-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--button-primary-hover);
        }

        button[style*="background-color: #27ae60"]:hover {
            background-color: #229954 !important;
        }

        button:disabled {
            background-color: var(--button-disabled);
            cursor: not-allowed;
        }

        .test-area {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            min-height: 200px;
            transition: background-color 0.3s;
        }

        .phrase-display {
            font-size: 28px;
            text-align: center;
            padding: 30px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-bottom: 20px;
            direction: rtl;
            line-height: 1.8;
            transition: background-color 0.3s;
        }

        .answer-display {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .answer-verse {
            font-size: 24px;
            direction: rtl;
            line-height: 2;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-right: 4px solid #3498db;
            transition: background-color 0.3s;
        }

        .answer-metadata {
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .answer-metadata div {
            margin-bottom: 5px;
        }

        .page-image-container {
            margin-top: 20px;
            text-align: center;
        }

        .page-image-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: border-color 0.3s;
        }

        .page-image-container .image-label {
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .error {
            color: var(--error-text);
            padding: 10px;
            background: var(--error-bg);
            border-radius: 4px;
            margin-bottom: 10px;
            transition: background-color 0.3s, color 0.3s;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 20px;
            }

            .container > div:first-child {
                position: static;
            }

            .container > div:first-child > div:last-child {
                position: static !important;
                display: flex;
                justify-content: center;
                margin-top: 10px;
                margin-bottom: 10px;
            }

            .phrase-display {
                font-size: 22px;
                padding: 20px;
            }

            .answer-verse {
                font-size: 20px;
            }

            button {
                padding: 10px 16px;
                font-size: 14px;
            }

            .juz-container {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="position: relative;">
            <h1 style="text-align: center;">Smallest Phrase Hifdh-Tester</h1>
            <p style="text-align: center; color: var(--text-quaternary); margin-bottom: 20px; font-size: 14px;">This hifdh-testing app shows you the smallest portion of the Quran required for you to identify the ayah. Pages are based on the Old Madinah Mushaf. Quran text is taken from <a href="https://tanzil.net/download/" target="_blank" style="color: #3498db;">tanzil.net</a>.</p>
            
            <div style="position: absolute; top: 0; right: 0;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px;">
                    <span style="margin-right: 8px;">ðŸŒ™</span>
                    <input type="checkbox" id="dark-mode-toggle" style="display: none;">
                    <div class="toggle-switch">
                        <div class="toggle-slider"></div>
                    </div>
                </label>
            </div>
        </div>
        
        <div id="loading" class="loading">Loading Quran data...</div>
        
        <div id="app" style="display: none;">
            <div class="controls">
                <div class="control-group">
                    <label><strong>Select Portion for Testing:</strong></label>
                    <div style="margin-top: 10px;">
                        <input type="radio" id="entire-quran" name="portion-type" value="entire" checked>
                        <label for="entire-quran" style="display: inline; font-weight: normal;">Entire Quran (default)</label>
                    </div>
                    <div style="margin-top: 5px;">
                        <input type="radio" id="select-portion" name="portion-type" value="select">
                        <label for="select-portion" style="display: inline; font-weight: normal;">Select Portion</label>
                    </div>
                </div>

                <div id="filter-options" class="filter-options-box" style="display: none;">
                    <div class="checkbox-group" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                        <input type="checkbox" id="unique-in-quran" checked>
                        <label for="unique-in-quran">Question is unique within entire Quran</label>
                        <span class="info-icon" onclick="toggleUniqueTooltip(event)">i</span>
                        <div id="unique-tooltip" class="info-tooltip">
                            If enabled, the question shown will be unique within the entire Quran, regardless of what portion of the Quran is selected. If disabled, the question will be unique <em>within the selected portion</em>, but may not be unique in the entire Quran.
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Surah Select:</label>
                        <div id="surah-container" class="surah-container">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Juz Select:</label>
                        <div id="juz-container" class="juz-container">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="page-range">Page Select (comma separated ranges, e.g. "1-100" or "1-100, 150-200"):</label>
                        <input type="text" id="page-range" placeholder="e.g., 1-100, 150-200, 300">
                        <div id="page-range-error" style="color: var(--error-text); font-size: 13px; margin-top: 5px; display: none;">Invalid Range</div>
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="single-verse-only" checked>
                    <label for="single-verse-only">Keep questions within one ayah</label>
                    <span class="info-icon" onclick="toggleTooltip(event)">i</span>
                    <div id="verse-tooltip" class="info-tooltip">
                        If selected, the question shown will be from within one ayah only. If deselected, the question may cross over multiple ayaat, or even to a new surah.
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="start-of-ayah">
                    <label for="start-of-ayah">Keep phrases at the beginning of an ayah</label>
                    <span class="info-icon" onclick="toggleStartAyahTooltip(event)">i</span>
                    <div id="start-ayah-tooltip" class="info-tooltip">
                        If selected, the question will always be from the beginning of an ayah. If deselected, the question can be from anywhere within an ayah.
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="show-ayah-marker">
                    <label for="show-ayah-marker">Show ayah marker</label>
                    <span class="info-icon" onclick="toggleAyahMarkerTooltip(event)">i</span>
                    <div id="ayah-marker-tooltip" class="info-tooltip">
                        If selected, the ayah marker will be shown at the end of ayahs. If deselected, there will be no ayah marker.
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="show-page-image" checked>
                    <label for="show-page-image">Show page image when revealing answer</label>
                </div>
            </div>

            <div class="button-group">
                <button id="new-question-btn" onclick="startNewQuestion()">New Question</button>
                <button id="change-settings-btn" onclick="showSettings()" style="display: none; background-color: #27ae60;">Change Settings</button>
            </div>

            <div id="error-message" class="error" style="display: none;"></div>

            <div id="test-area" class="test-area" style="display: none;">
                <div id="phrase-display" class="phrase-display"></div>
                
                <div class="button-group">
                    <button id="show-more-btn" onclick="showMoreWord()">Reveal Next Word</button>
                    <button id="show-previous-btn" onclick="showPreviousWord()">Reveal Previous Word</button>
                </div>
                <div class="button-group" style="margin-top: 10px;">
                    <button id="reveal-btn" onclick="revealAnswer()">Reveal Answer</button>
                    <button id="next-question-btn" onclick="startNewQuestion()" style="display: none;">New Question</button>
                </div>

                <div id="answer-display" class="answer-display" style="display: none;"></div>

                <div class="button-group" style="margin-top: 20px;">
                    <button id="bottom-question-btn" onclick="startNewQuestion()" style="display: none;">New Question</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let quranWords = [];
        let metadata = null;
        let currentQuestion = null;
        let displayedWords = [];

        // Load CSV file
        async function loadCSV() {
            const response = await fetch('quran_words.csv');
            const text = await response.text();
            const lines = text.trim().split('\n');
            
            // No header - start from first line
            for (let i = 0; i < lines.length; i++) {
                const parts = lines[i].split(',');
                if (parts.length >= 5) {
                    quranWords.push({
                        globalWordNumber: parseInt(parts[0]),
                        sura: parseInt(parts[1]),
                        aya: parseInt(parts[2]),
                        wordInAya: parseInt(parts[3]),
                        text: parts.slice(4).join(',') // In case text contains commas
                    });
                }
            }
        }

        // Load XML file
        async function loadXML() {
            const response = await fetch('app_quran_metadata.xml');
            const text = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, 'text/xml');
            
            metadata = {
                suras: [],
                juzs: [],
                pages: []
            };

            // Parse suras
            const suras = xmlDoc.querySelectorAll('sura');
            suras.forEach(sura => {
                metadata.suras.push({
                    index: parseInt(sura.getAttribute('index')),
                    name: sura.getAttribute('name')
                });
            });

            // Parse juzs
            const juzs = xmlDoc.querySelectorAll('juz');
            juzs.forEach(juz => {
                metadata.juzs.push({
                    index: parseInt(juz.getAttribute('index')),
                    sura: parseInt(juz.getAttribute('sura')),
                    aya: parseInt(juz.getAttribute('aya'))
                });
            });

            // Parse pages
            const pages = xmlDoc.querySelectorAll('page');
            pages.forEach(page => {
                metadata.pages.push({
                    index: parseInt(page.getAttribute('index')),
                    sura: parseInt(page.getAttribute('sura')),
                    aya: parseInt(page.getAttribute('aya'))
                });
            });
        }

        // Initialize the app
        async function init() {
            try {
                await loadCSV();
                await loadXML();
                
                // Populate surah checkboxes
                const surahContainer = document.getElementById('surah-container');
                metadata.suras.forEach(sura => {
                    const div = document.createElement('div');
                    div.className = 'surah-item';
                    div.innerHTML = `
                        <input type="checkbox" id="surah-${sura.index}" value="${sura.index}">
                        <label for="surah-${sura.index}">${sura.index}. ${sura.name}</label>
                    `;
                    surahContainer.appendChild(div);
                });

                // Populate juz checkboxes
                const juzContainer = document.getElementById('juz-container');
                for (let i = 1; i <= 30; i++) {
                    const div = document.createElement('div');
                    div.className = 'juz-item';
                    div.innerHTML = `
                        <input type="checkbox" id="juz-${i}" value="${i}">
                        <label for="juz-${i}">Juz ${i}</label>
                    `;
                    juzContainer.appendChild(div);
                }

                // Add event listener for portion type radio buttons
                document.querySelectorAll('input[name="portion-type"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const filterOptions = document.getElementById('filter-options');
                        if (e.target.value === 'select') {
                            filterOptions.style.display = 'block';
                        } else {
                            filterOptions.style.display = 'none';
                            // Clear all selections when switching to "Entire Quran"
                            clearSurahSelection();
                            clearJuzSelection();
                            clearPageRange();
                        }
                    });
                });

                // Add event listeners to clear other filters
                document.querySelectorAll('[id^="surah-"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            clearJuzSelection();
                            clearPageRange();
                        }
                    });
                });

                document.querySelectorAll('[id^="juz-"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            clearSurahSelection();
                            clearPageRange();
                        }
                    });
                });

                document.getElementById('page-range').addEventListener('input', (e) => {
                    const pageRangeError = document.getElementById('page-range-error');
                    if (e.target.value.trim()) {
                        clearSurahSelection();
                        clearJuzSelection();
                        
                        // Validate in real-time
                        const pages = parsePageRange(e.target.value.trim());
                        if (pages === null) {
                            pageRangeError.style.display = 'block';
                        } else {
                            pageRangeError.style.display = 'none';
                        }
                    } else {
                        pageRangeError.style.display = 'none';
                    }
                });

                // Update display when ayah marker option changes
                document.getElementById('show-ayah-marker').addEventListener('change', () => {
                    if (currentQuestion) {
                        displayPhrase();
                    }
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';

                // Dark mode toggle
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    darkModeToggle.checked = true;
                }

                darkModeToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.documentElement.setAttribute('data-theme', 'light');
                        localStorage.setItem('theme', 'light');
                    }
                });

                // Close tooltips when clicking outside
                document.addEventListener('click', function(event) {
                    const infoIcon = event.target.closest('.info-icon');
                    if (!infoIcon) {
                        const verseTooltip = document.getElementById('verse-tooltip');
                        const uniqueTooltip = document.getElementById('unique-tooltip');
                        const ayahMarkerTooltip = document.getElementById('ayah-marker-tooltip');
                        const startAyahTooltip = document.getElementById('start-ayah-tooltip');
                        if (verseTooltip) verseTooltip.classList.remove('show');
                        if (uniqueTooltip) uniqueTooltip.classList.remove('show');
                        if (ayahMarkerTooltip) ayahMarkerTooltip.classList.remove('show');
                        if (startAyahTooltip) startAyahTooltip.classList.remove('show');
                    }
                });
            } catch (error) {
                document.getElementById('loading').textContent = 'Error loading data. Please ensure quran_words.csv and app_quran_metadata.xml are in the same folder as this HTML file.';
                console.error(error);
            }
        }

        function clearSurahSelection() {
            document.querySelectorAll('[id^="surah-"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function clearJuzSelection() {
            document.querySelectorAll('[id^="juz-"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function clearPageRange() {
            document.getElementById('page-range').value = '';
        }

        // Get filtered words based on user selection
        function getFilteredWords() {
            // Check which filter is active
            const selectedSuras = Array.from(document.querySelectorAll('[id^="surah-"]:checked')).map(cb => parseInt(cb.value));
            const selectedJuzs = Array.from(document.querySelectorAll('[id^="juz-"]:checked')).map(cb => parseInt(cb.value));
            const pageRangeText = document.getElementById('page-range').value.trim();

            if (selectedSuras.length > 0) {
                // Filter by surahs
                return quranWords.filter(word => selectedSuras.includes(word.sura));
            } else if (selectedJuzs.length > 0) {
                // Filter by juzs
                return quranWords.filter(word => {
                    const juz = findJuzForWord(word);
                    return selectedJuzs.includes(juz);
                });
            } else if (pageRangeText) {
                // Filter by page ranges
                const pages = parsePageRange(pageRangeText);
                if (pages === null || pages.length === 0) return []; // Invalid or empty range
                return quranWords.filter(word => {
                    const page = findPageForWord(word);
                    return pages.includes(page);
                });
            }

            // No filter, return all words
            return quranWords;
        }

        // Parse page range string like "1-10,15,450-500"
        function parsePageRange(rangeText) {
            const pages = new Set();
            const parts = rangeText.split(',');
            
            if (parts.length === 0 || rangeText.trim() === '') {
                return null;
            }
            
            for (let part of parts) {
                part = part.trim();
                if (part === '') continue;
                
                if (part.includes('-')) {
                    const rangeParts = part.split('-');
                    if (rangeParts.length !== 2) {
                        return null; // Invalid format
                    }
                    const start = parseInt(rangeParts[0].trim());
                    const end = parseInt(rangeParts[1].trim());
                    if (isNaN(start) || isNaN(end) || start < 1 || end > 604 || start > end) {
                        return null; // Invalid range
                    }
                    for (let i = start; i <= end; i++) {
                        pages.add(i);
                    }
                } else {
                    const page = parseInt(part);
                    if (isNaN(page) || page < 1 || page > 604) {
                        return null; // Invalid page number
                    }
                    pages.add(page);
                }
            }
            
            if (pages.size === 0) {
                return null;
            }
            
            return Array.from(pages);
        }

        // Find juz for a word
        function findJuzForWord(word) {
            for (let i = metadata.juzs.length - 1; i >= 0; i--) {
                const juz = metadata.juzs[i];
                if (word.sura > juz.sura || (word.sura === juz.sura && word.aya >= juz.aya)) {
                    return juz.index;
                }
            }
            return 1;
        }

        // Find page for a word
        function findPageForWord(word) {
            for (let i = metadata.pages.length - 1; i >= 0; i--) {
                const page = metadata.pages[i];
                if (word.sura > page.sura || (word.sura === page.sura && word.aya >= page.aya)) {
                    return page.index;
                }
            }
            return 1;
        }

        // Normalize text for comparison (remove shaddah at position 2)
        function normalizeForComparison(text) {
            if (text.length >= 2 && text.charCodeAt(1) === 0x0651) {
                return text.charAt(0) + text.substring(2);
            }
            return text;
        }

        // Check if a phrase is unique
        function isPhraseUnique(startIndex, length, filteredWords, checkAgainst) {
            // Build the phrase from filteredWords
            const phrase = [];
            for (let i = 0; i < length; i++) {
                if (startIndex + i >= filteredWords.length) return false;
                phrase.push(filteredWords[startIndex + i].text);
            }
            
            // Normalize the phrase for comparison
            const normalizedPhrase = phrase.map((word, idx) => 
                idx === 0 ? normalizeForComparison(word) : word
            );

            // Check if this exact sequence appears elsewhere in checkAgainst array
            let occurrences = 0;
            for (let i = 0; i <= checkAgainst.length - length; i++) {
                let matches = true;
                for (let j = 0; j < length; j++) {
                    const currentWord = checkAgainst[i + j].text;
                    const normalizedCurrent = j === 0 ? normalizeForComparison(currentWord) : currentWord;
                    if (normalizedCurrent !== normalizedPhrase[j]) {
                        matches = false;
                        break;
                    }
                }
                if (matches) {
                    occurrences++;
                    if (occurrences > 1) return false;
                }
            }

            return occurrences === 1;
        }

        // Find unique phrase starting from a word
        function findUniquePhraseFromIndex(startIndex, filteredWords, singleVerseOnly, checkAgainst) {
            const startWord = filteredWords[startIndex];
            let length = 1;
            
            while (startIndex + length <= filteredWords.length) {
                // Check if we've crossed verse boundary
                if (singleVerseOnly && length > 1) {
                    const currentWord = filteredWords[startIndex + length - 1];
                    if (currentWord.sura !== startWord.sura || currentWord.aya !== startWord.aya) {
                        // Crossed boundary, not found
                        return null;
                    }
                }

                if (isPhraseUnique(startIndex, length, filteredWords, checkAgainst)) {
                    // Found unique phrase
                    const phrase = [];
                    for (let i = 0; i < length; i++) {
                        phrase.push(filteredWords[startIndex + i]);
                    }
                    return {
                        words: phrase,
                        startIndex: startIndex,
                        length: length
                    };
                }

                length++;
            }

            return null;
        }

        // Start a new question
        function startNewQuestion() {
            const errorDiv = document.getElementById('error-message');
            const pageRangeError = document.getElementById('page-range-error');
            errorDiv.style.display = 'none';
            pageRangeError.style.display = 'none';

            const filteredWords = getFilteredWords();
            
            // Check if page range is invalid
            const pageRangeText = document.getElementById('page-range').value.trim();
            if (pageRangeText) {
                const pages = parsePageRange(pageRangeText);
                if (pages === null) {
                    pageRangeError.style.display = 'block';
                    return;
                }
            }
            
            if (filteredWords.length === 0) {
                errorDiv.textContent = 'No words available with current filter settings.';
                errorDiv.style.display = 'block';
                return;
            }

            const singleVerseOnly = document.getElementById('single-verse-only').checked;
            const startOfAyah = document.getElementById('start-of-ayah').checked;
            const uniqueInQuran = document.getElementById('unique-in-quran') ? 
                                  document.getElementById('unique-in-quran').checked : true;
            
            // Determine which word list to check uniqueness against
            const checkAgainst = uniqueInQuran ? quranWords : filteredWords;
            
            // Filter to only words at the start of ayah if option is selected
            let wordsToSearchFrom = filteredWords;
            if (startOfAyah) {
                wordsToSearchFrom = filteredWords.filter(word => word.wordInAya === 1);
                if (wordsToSearchFrom.length === 0) {
                    errorDiv.textContent = 'No words at the beginning of ayahs available with current filter settings.';
                    errorDiv.style.display = 'block';
                    return;
                }
            }
            
            let uniquePhrase = null;
            let attempts = 0;
            const maxAttempts = 100;

            while (!uniquePhrase && attempts < maxAttempts) {
                const randomIndex = Math.floor(Math.random() * wordsToSearchFrom.length);
                uniquePhrase = findUniquePhraseFromIndex(randomIndex, wordsToSearchFrom, singleVerseOnly, checkAgainst);
                attempts++;
            }

            if (!uniquePhrase) {
                errorDiv.textContent = 'Could not find a unique phrase. Try different filter settings.';
                errorDiv.style.display = 'block';
                return;
            }

            currentQuestion = {
                uniquePhrase: uniquePhrase,
                filteredWords: filteredWords,
                wordsToSearchFrom: wordsToSearchFrom // Store which array was used
            };

            displayedWords = uniquePhrase.words.slice();
            displayPhrase();

            // Hide controls once testing begins
            document.querySelector('.controls').style.display = 'none';
            document.getElementById('change-settings-btn').style.display = 'inline-block';
            document.getElementById('new-question-btn').style.display = 'inline-block';
            document.getElementById('new-question-btn').textContent = 'New Question';

            document.getElementById('test-area').style.display = 'block';
            document.getElementById('answer-display').style.display = 'none';
            document.getElementById('show-more-btn').style.display = 'inline-block';
            document.getElementById('show-more-btn').disabled = false;
            document.getElementById('show-previous-btn').style.display = 'inline-block';
            
            // Check if we're at the beginning of the Quran and disable previous button if so
            const firstDisplayedWord = displayedWords[0];
            document.getElementById('show-previous-btn').disabled = (firstDisplayedWord.globalWordNumber === 1);
            
            document.getElementById('reveal-btn').style.display = 'inline-block';
            document.getElementById('reveal-btn').disabled = false;
            document.getElementById('next-question-btn').style.display = 'none';
            document.getElementById('bottom-question-btn').style.display = 'none';
        }

        // Show settings to change filters
        function showSettings() {
            document.querySelector('.controls').style.display = 'block';
            document.getElementById('test-area').style.display = 'none';
            document.getElementById('change-settings-btn').style.display = 'none';
            document.getElementById('new-question-btn').style.display = 'inline-block';
            document.getElementById('page-range-error').style.display = 'none';
            currentQuestion = null;
        }

        // Toggle tooltip visibility
        function toggleTooltip(event) {
            event.stopPropagation();
            const tooltip = document.getElementById('verse-tooltip');
            tooltip.classList.toggle('show');
        }

        // Toggle unique tooltip visibility
        function toggleUniqueTooltip(event) {
            event.stopPropagation();
            const tooltip = document.getElementById('unique-tooltip');
            tooltip.classList.toggle('show');
        }

        // Toggle ayah marker tooltip visibility
        function toggleAyahMarkerTooltip(event) {
            event.stopPropagation();
            const tooltip = document.getElementById('ayah-marker-tooltip');
            tooltip.classList.toggle('show');
        }

        // Toggle start ayah tooltip visibility
        function toggleStartAyahTooltip(event) {
            event.stopPropagation();
            const tooltip = document.getElementById('start-ayah-tooltip');
            tooltip.classList.toggle('show');
        }

        // Display the current phrase
        function displayPhrase() {
            const phraseDiv = document.getElementById('phrase-display');
            const showAyahMarker = document.getElementById('show-ayah-marker').checked;
            
            if (!showAyahMarker) {
                // Simple display without markers
                phraseDiv.textContent = displayedWords.map(w => w.text).join(' ');
            } else {
                // Display with ayah markers at boundaries
                let displayText = '';
                for (let i = 0; i < displayedWords.length; i++) {
                    displayText += displayedWords[i].text;
                    
                    // Check if next word is from a different ayah
                    if (i < displayedWords.length - 1) {
                        const currentWord = displayedWords[i];
                        const nextWord = displayedWords[i + 1];
                        
                        // If crossing ayah boundary, add marker
                        if (currentWord.sura !== nextWord.sura || currentWord.aya !== nextWord.aya) {
                            displayText += ' \u06DD'; // Ayah marker
                        }
                        displayText += ' ';
                    }
                }
                phraseDiv.textContent = displayText;
            }
        }

        // Show one more word
        function showMoreWord() {
            if (!currentQuestion) return;

            // Find the last displayed word's global position in the entire Quran
            const lastDisplayedWord = displayedWords[displayedWords.length - 1];
            const nextGlobalNumber = lastDisplayedWord.globalWordNumber + 1;
            
            // Find the next word in the actual Quran
            const nextWord = quranWords.find(w => w.globalWordNumber === nextGlobalNumber);
            
            if (nextWord) {
                displayedWords.push(nextWord);
                displayPhrase();
            } else {
                // Reached end of Quran
                document.getElementById('show-more-btn').disabled = true;
            }
        }

        // Show previous word
        function showPreviousWord() {
            if (!currentQuestion) return;

            // Find the first displayed word's global position in the entire Quran
            const firstDisplayedWord = displayedWords[0];
            const prevGlobalNumber = firstDisplayedWord.globalWordNumber - 1;
            
            // Find the previous word in the actual Quran
            const prevWord = quranWords.find(w => w.globalWordNumber === prevGlobalNumber);
            
            if (prevWord) {
                displayedWords.unshift(prevWord);
                displayPhrase();
            } else {
                // Reached beginning of Quran
                document.getElementById('show-previous-btn').disabled = true;
            }
        }

        // Reveal the answer
        function revealAnswer() {
            if (!currentQuestion) return;

            const answerDiv = document.getElementById('answer-display');
            answerDiv.innerHTML = '';

            // Get all verses that contain the unique phrase
            const firstWord = currentQuestion.uniquePhrase.words[0];
            const lastWord = currentQuestion.uniquePhrase.words[currentQuestion.uniquePhrase.words.length - 1];

            const verses = new Set();
            currentQuestion.uniquePhrase.words.forEach(word => {
                verses.add(`${word.sura}:${word.aya}`);
            });

            // Display each verse
            verses.forEach(verseKey => {
                const [sura, aya] = verseKey.split(':').map(n => parseInt(n));
                const verseWords = quranWords.filter(w => w.sura === sura && w.aya === aya);
                const verseText = verseWords.map(w => w.text).join(' ');

                const verseDiv = document.createElement('div');
                verseDiv.className = 'answer-verse';
                verseDiv.textContent = verseText;
                answerDiv.appendChild(verseDiv);
            });

            // Display metadata
            const surahName = metadata.suras.find(s => s.index === firstWord.sura).name;
            const juz = findJuzForWord(firstWord);
            const page = findPageForWord(firstWord);

            // Handle ayah display - check if cross-surah
            let ayahDisplay;
            if (verses.size > 1) {
                if (firstWord.sura !== lastWord.sura) {
                    // Cross-surah: show both locations
                    const lastSurahName = metadata.suras.find(s => s.index === lastWord.sura).name;
                    ayahDisplay = `${surahName} ${firstWord.aya} - ${lastSurahName} ${lastWord.aya}`;
                } else {
                    // Same surah, multiple ayahs
                    ayahDisplay = `${firstWord.aya} - ${lastWord.aya}`;
                }
            } else {
                // Single ayah
                ayahDisplay = `${firstWord.aya}`;
            }

            const metadataDiv = document.createElement('div');
            metadataDiv.className = 'answer-metadata';
            metadataDiv.innerHTML = `
                <div><strong>Surah:</strong> ${surahName} (${firstWord.sura})</div>
                <div><strong>Ayah:</strong> ${ayahDisplay}</div>
                <div><strong>Juz:</strong> ${juz}</div>
                <div><strong>Page:</strong> ${page}</div>
            `;
            answerDiv.appendChild(metadataDiv);

            // Display page image if enabled
            const showPageImage = document.getElementById('show-page-image').checked;
            if (showPageImage) {
                const pageImageContainer = document.createElement('div');
                pageImageContainer.className = 'page-image-container';
                
                const imageLabel = document.createElement('div');
                imageLabel.className = 'image-label';
                imageLabel.textContent = `Page ${page} - ${surahName}`;
                pageImageContainer.appendChild(imageLabel);

                const pageNumber = String(page).padStart(3, '0');
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                const imageFolder = isDarkMode ? 'dark_mode_images' : 'images';
                const img = document.createElement('img');
                img.src = `${imageFolder}/${pageNumber}.png`;
                img.alt = `Page ${page}`;
                img.onerror = function() {
                    this.style.display = 'none';
                    const errorMsg = document.createElement('div');
                    errorMsg.style.color = 'var(--error-text)';
                    errorMsg.style.fontSize = '14px';
                    errorMsg.textContent = `Image not found: ${imageFolder}/${pageNumber}.png`;
                    pageImageContainer.appendChild(errorMsg);
                };
                pageImageContainer.appendChild(img);

                answerDiv.appendChild(pageImageContainer);
            }

            answerDiv.style.display = 'block';
            document.getElementById('show-more-btn').style.display = 'none';
            document.getElementById('show-previous-btn').style.display = 'none';
            document.getElementById('reveal-btn').style.display = 'none';
            document.getElementById('next-question-btn').style.display = 'inline-block';
            document.getElementById('new-question-btn').style.display = 'none';
            document.getElementById('bottom-question-btn').style.display = 'inline-block';
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
